<!-- src/pages/legacy-purchase.astro -->

---
import Layout from '../layouts/Layout.astro';

export const prerender = true;
---

<Layout>
  <main class="container mx-auto max-w-2xl py-16 md:py-24 px-6">
    <!-- [SECTION 1: THE PACKAGE & PRICING] -->
    <section class="text-center border-b pb-12">
      <h1 class="text-4xl md:text-5xl font-migra text-brand-black mb-2">The Complete Legacy Library</h1>
      <p class="text-lg font-open-sauce mb-6">One all-inclusive package. One priceless family heirloom.</p>
      <p class="text-5xl font-migra text-brand-navy mb-2">$849 NZD</p>
      <p class="text-md font-open-sauce mb-6">or 4 interest-free payments of $212.25 with <strong>[Afterpay Logo]</strong></p>
      <div class="flex justify-center items-center gap-4 text-sm text-gray-600">
        <span>Pay securely with:</span>
        <div class="flex gap-2">
          <span>[Visa]</span>
          <span>[Mastercard]</span>
          <span>[Apple Pay]</span>
        </div>
      </div>
    </section>

    <!-- [SECTION 2: VALUE STACK - WHAT'S INCLUDED] -->
    <section class="py-12 border-b">
      <h2 class="text-3xl font-migra text-brand-black mb-8">Everything Included in Your Journey</h2>
      <ul class="space-y-4">
        <li class="flex items-start">
          <svg class="w-6 h-6 text-vital-lime mr-3 mt-1 shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
          <span>A Personal Discovery Session to map out the journey.</span>
        </li>
        <li class="flex items-start">
          <svg class="w-6 h-6 text-vital-lime mr-3 mt-1 shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
          <span><strong>15 Hours</strong> of AI Conversation with your empathetic guide, Peg.</span>
        </li>
        <li class="flex items-start">
          <svg class="w-6 h-6 text-vital-lime mr-3 mt-1 shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
          <span>A Guided <strong>3-Month Experience</strong> at the storyteller's own pace.</span>
        </li>
        <li class="flex items-start">
          <svg class="w-6 h-6 text-vital-lime mr-3 mt-1 shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
          <span>Family & Friends Contribution Portal to include everyone's voice.</span>
        </li>
        <li class="flex items-start">
          <svg class="w-6 h-6 text-vital-lime mr-3 mt-1 shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
          <span>Professional Curation & Editing of all transcripts.</span>
        </li>
        <li class="flex items-start">
          <svg class="w-6 h-6 text-vital-lime mr-3 mt-1 shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
          <span>Personal Review & Photo Integration for the final manuscript.</span>
        </li>
        <li class="flex items-start">
          <svg class="w-6 h-6 text-vital-lime mr-3 mt-1 shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
          <span>The Heirloom Hardback Book, printed on archival-quality paper.</span>
        </li>
         <li class="flex items-start">
          <svg class="w-6 h-6 text-vital-lime mr-3 mt-1 shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
          <span>The Complete Digital & Audio Archive (PDF, Flipbook, and all voice recordings).</span>
        </li>
      </ul>
    </section>

    <!-- [SECTION 3: CHECKOUT & GIFTING OPTIONS] -->
    <section class="pt-12">
      <h2 class="text-3xl font-migra text-brand-black mb-8">Begin the Journey Today</h2>
      <form class="space-y-8">
        <!-- Gifting Options -->
        <div class="space-y-4">
            <label class="font-bold text-lg">Choose Your Gifting Experience</label>
            <div class="border p-4 rounded-md has-checked:bg-lime-50 has-checked:border-vital-lime">
                <input type="radio" id="digital" name="gifting_experience" value="digital" class="mr-2" checked>
                <label for="digital"><strong>Instant Digital Gift Certificate</strong><br><span class="text-sm">Perfect for sending immediately. You'll receive a beautiful, shareable link right after purchase.</span></label>
            </div>
             <div class="border p-4 rounded-md has-checked:bg-lime-50 has-checked:border-vital-lime">
                <input type="radio" id="physical" name="gifting_experience" value="physical" class="mr-2">
                <label for="physical"><strong>Mail a Physical Gift Certificate</strong><br><span class="text-sm">We'll send a premium, boxed gift certificate to the address of your choice. Please allow 5-7 business days.</span></label>
            </div>
        </div>

        <!-- Your Info -->
        <div class="space-y-4">
             <label class="font-bold text-lg">Your Information</label>
             <div>
                <label for="your_name" class="block text-sm font-medium">Your Full Name</label>
                <input type="text" id="your_name" name="your_name" class="mt-1 block w-full border border-gray-300 rounded-md p-2">
             </div>
             <div>
                <label for="your_email" class="block text-sm font-medium">Your Email Address</label>
                <input type="email" id="your_email" name="your_email" class="mt-1 block w-full border border-gray-300 rounded-md p-2">
             </div>
        </div>
        
        <!-- Storyteller Info -->
        <div class="space-y-4">
             <label class="font-bold text-lg">Who is this Gift For?</label>
             <div>
                <label for="storyteller_name" class="block text-sm font-medium">Storyteller's Full Name</label>
                <input type="text" id="storyteller_name" name="storyteller_name" class="mt-1 block w-full border border-gray-300 rounded-md p-2">
             </div>
             <div>
                <label for="storyteller_email" class="block text-sm font-medium">Storyteller's Email Address</label>
                <input type="email" id="storyteller_email" name="storyteller_email" class="mt-1 block w-full border border-gray-300 rounded-md p-2">
             </div>
        </div>

        <!-- Submit & Guarantee -->
        <div class="md:flex items-center gap-6">
            <button type="submit" id="checkout-button" class="w-full md:w-auto bg-brand-navy text-warm-parchment font-open-sauce uppercase tracking-wider py-4 px-10 hover:bg-opacity-90 transition-colors rounded-md disabled:opacity-50 disabled:cursor-not-allowed">
                <span id="button-text">Continue to Payment</span>
                <span id="button-spinner" class="hidden">Processing...</span>
            </button>
            <div class="mt-4 md:mt-0 flex items-center gap-2 text-sm text-gray-600">
                <svg class="w-8 h-8 text-vital-lime shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75m-3-7.036A11.959 11.959 0 013.598 6 11.99 11.99 0 003 9.749c0 5.592 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.31-.21-2.571-.598-3.751h-.152c-3.196 0-6.1-1.248-8.25-3.286zm0 13.036h.008v.008h-.008v-.008z" /></svg>
                <span><strong>Our "First Conversation" Promise:</strong> Full refund if the storyteller doesn't love their first conversation.</span>
            </div>
        </div>
      </form>
    </section>
  </main>
</Layout>

<script>
  const form = document.querySelector('form') as HTMLFormElement;
  const submitButton = document.getElementById('checkout-button') as HTMLButtonElement;
  const buttonText = document.getElementById('button-text') as HTMLSpanElement;
  const buttonSpinner = document.getElementById('button-spinner') as HTMLSpanElement;

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();

    // Get form values
    const formData = new FormData(form);
    const yourName = formData.get('your_name') as string;
    const yourEmail = formData.get('your_email') as string;
    const storytellerName = formData.get('storyteller_name') as string;
    const storytellerEmail = formData.get('storyteller_email') as string;
    const giftingType = formData.get('gifting_experience') as string;

    // Basic validation
    if (!yourName || !yourEmail || !storytellerName || !storytellerEmail) {
      alert('Please fill in all required fields');
      return;
    }

    // Email validation
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(yourEmail) || !emailRegex.test(storytellerEmail)) {
      alert('Please enter valid email addresses');
      return;
    }

    // Disable button and show loading state
    submitButton.disabled = true;
    buttonText.classList.add('hidden');
    buttonSpinner.classList.remove('hidden');

    try {
      // Call your API to create a checkout session
      const response = await fetch('/api/stripe/checkout', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          email: yourEmail,
          yourName: yourName,
          storytellerName: storytellerName,
          storytellerEmail: storytellerEmail,
          giftingType: giftingType,
        }),
      });

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.error || 'Something went wrong');
      }

      // Redirect to Stripe Checkout
      if (data.url) {
        window.location.href = data.url;
      } else {
        throw new Error('No checkout URL returned');
      }
    } catch (error: any) {
      console.error('Error:', error);
      alert('There was an error processing your request. Please try again.');

      // Re-enable button
      submitButton.disabled = false;
      buttonText.classList.remove('hidden');
      buttonSpinner.classList.add('hidden');
    }
  });
</script>